<!DOCTYPE html>
<html>
<head>
    <title>MechArm Control</title>
    <meta charset="UTF-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #1a1a1a; color: #0f0; font-family: monospace; overflow: hidden; }
        .container { display: grid; grid-template-columns: 1fr 450px; height: 100vh; }
        .lang-toggle { position: absolute; top: 10px; right: 15px; background: #333; color: #0f0; border: 1px solid #0f0; padding: 4px 10px; font-family: monospace; font-size: 13px; cursor: pointer; border-radius: 3px; z-index: 10; }
        .lang-toggle:hover { background: #0f0; color: #000; }
        .video-panel { background: #000; display: flex; flex-direction: column; border-right: 2px solid #0f0; }
        .video-header { background: #0f0; color: #000; padding: 15px; font-size: 20px; font-weight: bold; text-align: center; }
        .video-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .video-wrapper { position: relative; display: inline-block; border: 2px solid #0f0; }
        #video { display: block; max-width: 100%; max-height: 100%; }
        #detect-canvas { display: none; }
        #overlay-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #overlay-canvas.active { pointer-events: auto; cursor: crosshair; }
        .control-panel { background: #111; padding: 20px; overflow-y: auto; }
        .header { background: #0f0; color: #000; padding: 15px; margin: -20px -20px 20px -20px; text-align: center; font-size: 18px; font-weight: bold; }
        .section-title { color: #0f0; font-size: 16px; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #0f0; }
        .joint-control { background: #222; border: 2px solid #0f0; border-radius: 5px; padding: 12px; margin-bottom: 12px; }
        .joint-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; font-weight: bold; }
        .joint-value { color: #ff0; font-size: 16px; min-width: 60px; text-align: right; }
        .slider { width: 100%; height: 8px; border-radius: 5px; background: #333; outline: none; -webkit-appearance: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #0f0; cursor: pointer; box-shadow: 0 0 10px #0f0; }
        .range-labels { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-top: 3px; }
        .gripper-control { background: #222; border: 2px solid #ff0; border-radius: 5px; padding: 15px; margin: 15px 0; }
        .gripper-slider { background: linear-gradient(90deg, #333 0%, #ff0 100%); }
        .gripper-slider::-webkit-slider-thumb { background: #ff0; box-shadow: 0 0 10px #ff0; }
        .gripper-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn { background: #0f0; color: #000; border: none; padding: 10px; font-size: 13px; font-weight: bold; cursor: pointer; border-radius: 5px; margin: 5px 0; }
        .btn:hover { background: #0c0; }
        .btn-gripper { background: #ff0; }
        .btn-gripper:hover { background: #fc0; }
        .status { background: #000; border: 2px solid #0f0; padding: 10px; margin-top: 15px; border-radius: 5px; text-align: center; font-size: 13px; }
        .conn-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }
        .conn-ok { background: #0f0; box-shadow: 0 0 4px #0f0; }
        .conn-lost { background: #f00; box-shadow: 0 0 4px #f00; }
        .detect-section { background: #222; border: 2px solid #0f0; border-radius: 5px; padding: 15px; margin: 15px 0; }
        .detect-toggle { width: 100%; }
        .detect-toggle.loading { background: #888; color: #000; cursor: wait; }
        .detect-status { color: #888; font-size: 12px; margin-top: 8px; text-align: center; }
        .target-panel { background: #111; border: 1px solid #ff0; border-radius: 4px; padding: 10px; margin-top: 10px; display: none; }
        .target-panel.visible { display: block; }
        .target-info { color: #ff0; font-size: 13px; margin-bottom: 8px; }
        .target-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-target { background: #ff0; color: #000; border: none; padding: 8px; font-size: 12px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .btn-target:hover { background: #fc0; }
        .btn-clear { background: #333; color: #0f0; border: 1px solid #0f0; }
        .btn-clear:hover { background: #444; }
        @media (max-width: 800px) {
            .container { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .video-panel { border-right: none; border-bottom: 2px solid #0f0; }
            body { overflow: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="video-panel">
            <div class="video-header" data-i18n="videoHeader">Live Video Feed</div>
            <div class="video-container">
                <div class="video-wrapper">
                    <img id="video" src="/video">
                    <canvas id="detect-canvas" width="480" height="360"></canvas>
                    <canvas id="overlay-canvas" width="480" height="360"></canvas>
                </div>
            </div>
        </div>
        <div class="control-panel" style="position:relative;">
            <div class="header" data-i18n="header">Robot Arm Control</div>
            <button class="lang-toggle" onclick="toggleLang()">中文</button>

            <div class="section-title" data-i18n="jointControl">Joint Control</div>

            <div class="joint-control">
                <div class="joint-header"><span data-i18n="j1">J1 Base</span><span class="joint-value" id="v1">0&deg;</span></div>
                <input type="range" class="slider" id="j1" min="-160" max="160" value="0">
                <div class="range-labels"><span>-160&deg;</span><span>+160&deg;</span></div>
            </div>

            <div class="joint-control">
                <div class="joint-header"><span>J2</span><span class="joint-value" id="v2">0&deg;</span></div>
                <input type="range" class="slider" id="j2" min="-90" max="90" value="0">
                <div class="range-labels"><span>-90&deg;</span><span>+90&deg;</span></div>
            </div>

            <div class="joint-control">
                <div class="joint-header"><span>J3</span><span class="joint-value" id="v3">0&deg;</span></div>
                <input type="range" class="slider" id="j3" min="-180" max="45" value="0">
                <div class="range-labels"><span>-180&deg;</span><span>+45&deg;</span></div>
            </div>

            <div class="joint-control">
                <div class="joint-header"><span>J4</span><span class="joint-value" id="v4">0&deg;</span></div>
                <input type="range" class="slider" id="j4" min="-160" max="160" value="0">
                <div class="range-labels"><span>-160&deg;</span><span>+160&deg;</span></div>
            </div>

            <div class="joint-control">
                <div class="joint-header"><span>J5</span><span class="joint-value" id="v5">0&deg;</span></div>
                <input type="range" class="slider" id="j5" min="-100" max="100" value="0">
                <div class="range-labels"><span>-100&deg;</span><span>+100&deg;</span></div>
            </div>

            <div class="joint-control">
                <div class="joint-header"><span data-i18n="j6">J6 End</span><span class="joint-value" id="v6">0&deg;</span></div>
                <input type="range" class="slider" id="j6" min="-180" max="180" value="0">
                <div class="range-labels"><span>-180&deg;</span><span>+180&deg;</span></div>
            </div>

            <div class="section-title" data-i18n="gripperControl">Gripper Control</div>

            <div class="gripper-control">
                <div class="joint-header"><span data-i18n="gripperLabel">Gripper</span><span class="joint-value" id="vg" style="color:#ff0;">0%</span></div>
                <input type="range" class="slider gripper-slider" id="gripper" min="0" max="100" value="0">
                <div class="range-labels"><span data-i18n="fullyOpen">Fully Open</span><span data-i18n="fullyClosed">Fully Closed</span></div>
                <div class="gripper-buttons">
                    <button class="btn btn-gripper" onclick="openGripper()" data-i18n="openBtn">Open</button>
                    <button class="btn btn-gripper" onclick="closeGripper()" data-i18n="closeBtn">Close</button>
                </div>
            </div>

            <button class="btn" onclick="resetArm()" data-i18n="resetBtn">Reset All</button>
            <button class="btn" onclick="requestSync()" data-i18n="syncBtn">Sync Status</button>

            <div class="section-title" data-i18n="detectTitle">Object Detection</div>
            <div class="detect-section">
                <button class="btn detect-toggle" id="detect-btn" onclick="toggleDetection()" data-i18n="enableDetect">Enable Detection</button>
                <div class="detect-status" id="detect-status"></div>
                <div class="target-panel" id="target-panel">
                    <div class="target-info" id="target-info"></div>
                    <div class="target-buttons">
                        <button class="btn-target" onclick="sendTarget()" data-i18n="moveToTarget">Move to Target</button>
                        <button class="btn-target btn-clear" onclick="clearTarget()" data-i18n="clearTarget">Clear</button>
                    </div>
                </div>
            </div>

            <div class="status" id="st"><span class="conn-indicator conn-ok" id="conn-dot"></span><span data-i18n="ready" id="st-text">Ready</span></div>
        </div>
    </div>
    <script>
        const i18n = {
            en: {
                videoHeader: 'Live Video Feed', header: 'Robot Arm Control',
                jointControl: 'Joint Control', j1: 'J1 Base', j6: 'J6 End',
                gripperControl: 'Gripper Control', gripperLabel: 'Gripper',
                fullyOpen: 'Fully Open', fullyClosed: 'Fully Closed',
                openBtn: 'Open', closeBtn: 'Close',
                resetBtn: 'Reset All', syncBtn: 'Sync Status',
                ready: 'Ready', synced: 'Synced', toggleLabel: '中文',
                disconnected: 'Disconnected — arm going to safe position',
                detectTitle: 'Object Detection',
                enableDetect: 'Enable Detection', disableDetect: 'Disable Detection',
                loadingModel: 'Loading model...', moveToTarget: 'Move to Target',
                clearTarget: 'Clear'
            },
            zh: {
                videoHeader: '实时视频监控', header: '机械臂完整控制',
                jointControl: '关节控制', j1: 'J1 底座', j6: 'J6 末端',
                gripperControl: '夹具控制', gripperLabel: '夹具开合',
                fullyOpen: '完全张开', fullyClosed: '完全闭合',
                openBtn: '张开', closeBtn: '闭合',
                resetBtn: '全部归零', syncBtn: '同步状态',
                ready: '就绪', synced: '已同步', toggleLabel: 'EN',
                disconnected: '连接断开 — 机械臂回到安全位置',
                detectTitle: '目标检测',
                enableDetect: '启用检测', disableDetect: '禁用检测',
                loadingModel: '加载模型中...', moveToTarget: '移动到目标',
                clearTarget: '清除'
            }
        };

        let lang = localStorage.getItem('mecharm_lang') || 'en';
        function t(key) { return i18n[lang][key] || key; }

        function applyLang() {
            const tr = i18n[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (tr[key]) el.textContent = tr[key];
            });
            document.querySelector('.lang-toggle').textContent = tr.toggleLabel;
            document.title = lang === 'en' ? 'MechArm Control' : 'MechArm 完整控制';
        }

        function toggleLang() {
            lang = lang === 'en' ? 'zh' : 'en';
            localStorage.setItem('mecharm_lang', lang);
            applyLang();
        }

        // --- WebSocket control channel ---
        let ws = null;
        let wsReady = false;

        function connectWS() {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${proto}//${location.host}/ws`);

            ws.onopen = () => {
                wsReady = true;
                setConnStatus(true);
                requestSync();
            };

            ws.onmessage = (evt) => {
                const msg = JSON.parse(evt.data);
                if (msg.type === 'sync') {
                    if (msg.a) {
                        for (let i = 0; i < 6; i++) {
                            let v = Math.round(msg.a[i]);
                            document.getElementById('j'+(i+1)).value = v;
                            document.getElementById('v'+(i+1)).textContent = v+'°';
                        }
                    }
                    if (msg.g !== undefined) {
                        document.getElementById('gripper').value = msg.g;
                        document.getElementById('vg').textContent = msg.g+'%';
                    }
                    setStatus(t('synced'));
                } else if (msg.type === 'ack') {
                    setStatus(msg.m);
                } else if (msg.type === 'target_ack') {
                    setStatus(msg.m);
                } else if (msg.type === 'pong') {
                    // heartbeat response
                }
            };

            ws.onclose = () => {
                wsReady = false;
                setConnStatus(false);
                setTimeout(connectWS, 2000);
            };

            ws.onerror = () => {
                ws.close();
            };
        }

        // Heartbeat: ping every 2s
        setInterval(() => {
            if (ws && wsReady) {
                ws.send(JSON.stringify({type: 'ping'}));
            }
        }, 2000);

        function setConnStatus(ok) {
            const dot = document.getElementById('conn-dot');
            dot.className = 'conn-indicator ' + (ok ? 'conn-ok' : 'conn-lost');
            if (!ok) setStatus(t('disconnected'));
        }

        function setStatus(text) {
            document.getElementById('st-text').textContent = text;
        }

        function wsSend(msg) {
            if (ws && wsReady) {
                ws.send(JSON.stringify(msg));
                return true;
            }
            return false;
        }

        // --- Joint control ---
        let pendingJoints = {};
        let jointTimer = null;

        function flushJoints() {
            let joints = pendingJoints;
            pendingJoints = {};
            jointTimer = null;
            if (wsSend({type: 'angles', joints: joints})) return;
            // HTTP fallback
            fetch('/update', {method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({joints:joints})})
            .then(r=>r.json()).then(d=>setStatus(d.m));
        }

        for (let i = 1; i <= 6; i++) {
            document.getElementById('j'+i).oninput = function() {
                let a = parseInt(this.value);
                document.getElementById('v'+i).textContent = a+'°';
                pendingJoints[i] = a;
                if (!jointTimer) jointTimer = setTimeout(flushJoints, 40);
            }
        }

        // --- Gripper control ---
        let gripTimer = null;
        document.getElementById('gripper').oninput = function() {
            let v = parseInt(this.value);
            document.getElementById('vg').textContent = v+'%';
            if (gripTimer) clearTimeout(gripTimer);
            gripTimer = setTimeout(() => {
                gripTimer = null;
                if (wsSend({type: 'gripper', value: v})) return;
                fetch('/gripper', {method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({value:v})})
                .then(r=>r.json()).then(d=>setStatus(d.m));
            }, 40);
        }

        function openGripper() {
            document.getElementById('gripper').value = 0;
            document.getElementById('vg').textContent = '0%';
            if (wsSend({type: 'gripper', value: 0})) return;
            fetch('/gripper', {method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({value:0})})
            .then(r=>r.json()).then(d=>setStatus(d.m));
        }

        function closeGripper() {
            document.getElementById('gripper').value = 100;
            document.getElementById('vg').textContent = '100%';
            if (wsSend({type: 'gripper', value: 100})) return;
            fetch('/gripper', {method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({value:100})})
            .then(r=>r.json()).then(d=>setStatus(d.m));
        }

        function resetArm() {
            for (let i = 1; i <= 6; i++) {
                document.getElementById('j'+i).value = 0;
                document.getElementById('v'+i).textContent = '0°';
            }
            document.getElementById('gripper').value = 0;
            document.getElementById('vg').textContent = '0%';
            if (wsSend({type: 'reset'})) return;
            fetch('/reset', {method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({})}).then(r=>r.json())
                .then(d=>setStatus(d.m));
        }

        function requestSync() {
            if (wsSend({type: 'sync'})) return;
            fetch('/sync').then(r=>r.json()).then(d=>{
                if (d.a) {
                    for (let i = 0; i < 6; i++) {
                        let v = Math.round(d.a[i]);
                        document.getElementById('j'+(i+1)).value = v;
                        document.getElementById('v'+(i+1)).textContent = v+'°';
                    }
                }
                if (d.g !== undefined) {
                    document.getElementById('gripper').value = d.g;
                    document.getElementById('vg').textContent = d.g+'%';
                }
                setStatus(t('synced'));
            });
        }

        // Periodic sync via WS (every 30s)
        setInterval(requestSync, 30000);

        window.onload = function() {
            applyLang();
            connectWS();
        };

        // --- Object Detection (TF.js + COCO-SSD) ---

        let detectModel = null;
        let detectActive = false;
        let detectInterval = null;
        let inferenceRunning = false;
        let currentDetections = [];
        let selectedDetection = null;

        const detectCanvas = document.getElementById('detect-canvas');
        const detectCtx = detectCanvas.getContext('2d');
        const overlayCanvas = document.getElementById('overlay-canvas');
        const overlayCtx = overlayCanvas.getContext('2d');
        const detectBtn = document.getElementById('detect-btn');
        const detectStatus = document.getElementById('detect-status');
        const targetPanel = document.getElementById('target-panel');
        const targetInfo = document.getElementById('target-info');
        const videoImg = document.getElementById('video');

        async function loadDetectionModel() {
            if (detectModel) return detectModel;
            detectBtn.textContent = t('loadingModel');
            detectBtn.classList.add('loading');
            detectBtn.disabled = true;
            try {
                detectModel = await cocoSsd.load({base: 'lite_mobilenet_v2'});
                return detectModel;
            } catch (e) {
                console.error('Failed to load COCO-SSD model:', e);
                detectBtn.textContent = t('enableDetect');
                detectBtn.classList.remove('loading');
                detectBtn.disabled = false;
                setStatus('Model load failed');
                return null;
            }
        }

        async function toggleDetection() {
            if (detectActive) {
                stopDetection();
            } else {
                const model = await loadDetectionModel();
                if (model) startDetection();
            }
        }

        function startDetection() {
            detectActive = true;
            detectBtn.textContent = t('disableDetect');
            detectBtn.classList.remove('loading');
            detectBtn.disabled = false;
            overlayCanvas.classList.add('active');
            detectInterval = setInterval(detectFrame, 200);
        }

        function stopDetection() {
            detectActive = false;
            if (detectInterval) { clearInterval(detectInterval); detectInterval = null; }
            overlayCanvas.classList.remove('active');
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            detectBtn.textContent = t('enableDetect');
            detectStatus.textContent = '';
            currentDetections = [];
            clearTarget();
        }

        async function detectFrame() {
            if (inferenceRunning || !detectModel || !videoImg.complete) return;
            inferenceRunning = true;
            try {
                detectCtx.drawImage(videoImg, 0, 0, 480, 360);
                const t0 = performance.now();
                const predictions = await detectModel.detect(detectCanvas);
                const ms = Math.round(performance.now() - t0);
                detectStatus.textContent = ms + 'ms @ 5fps';

                currentDetections = predictions.filter(p => p.score >= 0.5);
                drawDetections();
            } catch (e) {
                console.error('Detection error:', e);
            }
            inferenceRunning = false;
        }

        function drawDetections() {
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            for (const det of currentDetections) {
                const [x, y, w, h] = det.bbox;
                const isSelected = selectedDetection === det;
                const color = isSelected ? '#ff0' : '#0f0';

                overlayCtx.strokeStyle = color;
                overlayCtx.lineWidth = 2;
                overlayCtx.strokeRect(x, y, w, h);

                const label = det.class + ' ' + Math.round(det.score * 100) + '%';
                overlayCtx.font = '13px monospace';
                const textW = overlayCtx.measureText(label).width + 6;
                overlayCtx.fillStyle = color;
                overlayCtx.fillRect(x, y - 18, textW, 18);
                overlayCtx.fillStyle = '#000';
                overlayCtx.fillText(label, x + 3, y - 4);
            }
        }

        overlayCanvas.addEventListener('click', function(e) {
            if (!detectActive || currentDetections.length === 0) return;
            const rect = overlayCanvas.getBoundingClientRect();
            const scaleX = overlayCanvas.width / rect.width;
            const scaleY = overlayCanvas.height / rect.height;
            const cx = (e.clientX - rect.left) * scaleX;
            const cy = (e.clientY - rect.top) * scaleY;

            selectedDetection = null;
            for (const det of currentDetections) {
                const [bx, by, bw, bh] = det.bbox;
                if (cx >= bx && cx <= bx + bw && cy >= by && cy <= by + bh) {
                    selectedDetection = det;
                    break;
                }
            }

            if (selectedDetection) {
                const det = selectedDetection;
                const centerX = Math.round(det.bbox[0] + det.bbox[2] / 2);
                const centerY = Math.round(det.bbox[1] + det.bbox[3] / 2);
                targetInfo.textContent = det.class + ' ' + Math.round(det.score * 100) + '%  (' + centerX + ', ' + centerY + ')';
                targetPanel.classList.add('visible');
            } else {
                clearTarget();
            }
            drawDetections();
        });

        function sendTarget() {
            if (!selectedDetection) return;
            const det = selectedDetection;
            const centerX = Math.round(det.bbox[0] + det.bbox[2] / 2);
            const centerY = Math.round(det.bbox[1] + det.bbox[3] / 2);
            wsSend({
                type: 'target',
                class: det.class,
                confidence: Math.round(det.score * 100) / 100,
                center: [centerX, centerY],
                image_size: [480, 360]
            });
        }

        function clearTarget() {
            selectedDetection = null;
            targetPanel.classList.remove('visible');
            targetInfo.textContent = '';
            drawDetections();
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2/dist/coco-ssd.min.js"></script>
</body>
</html>
